---
title: "PACHBOARD"
author: "X. Pouwels"
date: "3-12-2021"
output: 
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
---

```{r setup, include = FALSE}
library(pacheck)
library(knitr)
library(plotly)
data(df_pa)
```

# Aim (grant application)
The aim of this project is to develop a generic dashboard, e.g. a R shiny application to 1) inspect model inputs and outputs, 2) visualise the original inputs and outputs, 3) investigate the relationship between model inputs and outputs through metamodelling and data visualisation methods, 4) save the performed analyses.

# Structure shiny app
The envisoned R Shiny app will have the following tabs.
I've developed some functions already to implement.
Currently, I've only considered 2 strategies ("intervention" (`_in`) and "comparator" (`_comp`)).
What is shown in this document is based on the probabilistic analysis of a (toy) 3-states Health state transition model (Progression-free (PF), Progressed disease(PD), Dead(D)) depicted in Figure 1. The intervention is only having an effect on the probability of progression, and incurs costs in the Progression-Free health state.

## 1.	Upload of original health economic model inputs and outputs
Content:

- Welcome message
- Instructions
- Upload 1 file with inputs and outputs (or 2? inputs and outputs separately?)
- Select variables representing total costs and effects for each strategy (to calculate increments and (incremental) net benefits)

```{r calc_nb, echo = T}
df_pa <- calculate_nb(df = df_pa,
                      e_int = "QALY_int",
                      e_comp = "QALY_comp",
                      c_int = "Costs_int",
                      c_comp = "Costs_comp",
                      wtp = 80000)# calculate net benefits

```

## 2. Investigate model inputs and outputs
### a.	Summary statistics of (user-selected) model inputs and outputs
*To examine whether cost inputs are always positive for instance*

```{r smmr, echo = T}
df <- generate_sum_stats(df_pa)
kable(df)
rm(df)
```

### b.	Histogram, density distribution of (user-selected) model inputs and outputs
*To visually investigate the parameter distributions*

#### Single parameter
```{r dist_plot, echo = T}
p_1 <- vis_1_param(df = df_pa,
            param = "u_pfs",
            binwidth = NULL,
            type = "histogram",
            dist = c("norm", "beta", "gamma", "lnorm"))
p_1
```


### Two parameters
```{r vis_2_pars, wcho = T}
p_2p <- vis_2_params(df = df_pa,
                     param_1 = "u_pfs",
                     param_2 = "u_pd",
                     slope = 1,
                     check = "param_2 > param_1")
p_2p
#p_2p_interact <- ggplotly(p_2p)
#p_2p_interact
```

### c.	Possibility to fit user-selected distributions (beta, gamma, lognormal, normal) + visualisation.
*To cross check with parameters reported in documentation/report/ journal article, as an implementation check*
```{r dist_plot_2, echo = T}
p_2 <- vis_1_param(df = df_pa,
            param = "u_pfs",
            binwidth = NULL,
            type = "density",
            dist = c("norm", "beta", "gamma", "lnorm"))
p_2
```

## 3.	Investigate model outputs
### a.	Incremental cost-effectiveness plane
***Questions:***  

- ***Interactive plot? Possibility to select some outputs and see which probabilistic input parameters combination has led to these outputs***  
- ***Plotting relative density as well as introduced [here](https://resource-allocation.biomedcentral.com/articles/10.1186/s12962-020-00251-7)?***  
- ***Combination of incremental cost-effectiveness plane and histogram of the distribution of incremental costs and effects?***

```{r dist_plot_2p, echo = T}
p_3 <- plot_ice(df = df_pa,
                param_1 = "Inc_QALY",
                param_2 = "Inc_Costs",
                wtp = 80000)
p_3
```


### b.	Cost-effectiveness acceptability curve.
```{r ceac, echo = T}
m_ceac <- calculate_ceac(df = df_pa,
                     e_int = "QALY_int",
                     e_comp = "QALY_comp",
                     c_int = "Costs_int",
                     c_comp = "Costs_comp")

df_ceac <- as.data.frame(m_ceac)

plot_ceac(df = df_ceac,
          wtp = "WTP_threshold")
```

### c.	Histogram and density distribution of total and incremental costs and effects.
**Can use the function above!  **

###d.	Convergence graph of outcomes
```{r conv, echo = T}
plot_convergence(df = df_pa,
                 outcome = "iNMB"
                 )
```

### e.	Question: EVPI? Expected net loss? It is in een package van de DARTH.

## 4.	Investigate relation between inputs and outputs
### Single
```{r fit_metamod_single, echo = T}
lm_rr <- fit_lm_metamodel(df = df_pa,
                          x = "rr",
                          y = "iNMB")
plot(lm_rr)
```

### Multiple
```{r fit_metamod_mult, echo = T}
lm_full <- fit_lm_metamodel(df = df_pa,
                          x = c("rr", "u_pfs", "u_pd", "c_pfs", "c_pd", "c_thx", "p_pfspd", "p_pfsd", "p_pdd"),
                          y = "iNMB")
df_dsa <- dsa_lm_metamodel(df = df_pa,
                           lm_metamodel = lm_full)
plot_tornado(df = df_dsa,
             df_basecase = df_pa,
             outcome = "iNMB")
```

# Other activities
- Check results of deterministic sensitivity analyses using original model and metamodel.  
- Unit tests of data using `testthat`?  

